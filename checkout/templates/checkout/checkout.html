{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'checkout/css/checkout.css' %}">
{% endblock %}

{% block content %}
<div class="overlay"></div>

<div class="container mt-5 pt-5">
  <!-- Title -->
  <div class="row">
    <div class="col text-center">
      <h2 class="logo-font text-accent-blue mb-3">Checkout</h2>
      <p class="text-muted">Please fill in your details to complete your order.</p>
      <hr class="w-50 mx-auto" style="border-color: var(--accent-pink);">
    </div>
  </div>

  <div class="row mt-4">
    <!-- Order Summary -->
    <div class="col-12 col-lg-6 order-lg-last mb-5">
      <h5 class="text-accent-blue mb-3">Your Order ({{ product_count }})</h5>

      {% for item in bag_items %}
      <div class="row align-items-center mb-2">
        <div class="col-3">
          <a href="{% url 'products:product_detail' item.product.id %}">
            {% if item.product.image %}
              <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-fluid rounded shadow-sm">
            {% else %}
              <img src="{{ MEDIA_URL }}noimage.png" alt="{{ item.product.name }}" class="img-fluid rounded shadow-sm">
            {% endif %}
          </a>
        </div>
        <div class="col-6">
          <p class="mb-0"><strong>{{ item.product.name }}</strong></p>
          <p class="mb-0 small text-muted">Qty: {{ item.quantity }}</p>
        </div>
        <div class="col-3 text-right">
          <p class="mb-0 small">£{{ item.product.price|floatformat:2 }}</p>
        </div>
      </div>
      {% endfor %}

      <hr>
      <div class="row text-right">
        <div class="col-8 text-muted">
          <p>Order Total:</p>
          <p>Delivery:</p>
          <p><strong>Grand Total:</strong></p>
        </div>
        <div class="col-4">
          <p>£{{ total|floatformat:2 }}</p>
          <p>£{{ delivery|floatformat:2 }}</p>
          <p><strong>£{{ grand_total|floatformat:2 }}</strong></p>
        </div>
      </div>
    </div>

    <!-- Checkout Form -->
    <div class="col-12 col-lg-6">
      <form method="POST" action="{% url 'checkout' %}" id="payment-form" class="checkout-form bg-white p-4 rounded shadow-sm">
        {% csrf_token %}
        
        <!-- Contact Info -->
        <fieldset class="mb-4">
          <legend class="small text-accent-blue">Contact Details</legend>
          {{ order_form.full_name|as_crispy_field }}
          {{ order_form.email|as_crispy_field }}
        </fieldset>

        <!-- Delivery Info -->
        <fieldset class="mb-4">
          <legend class="small text-accent-blue">Delivery Info</legend>
          {{ order_form.phone_number|as_crispy_field }}
          {{ order_form.country|as_crispy_field }}
          {{ order_form.postcode|as_crispy_field }}
          {{ order_form.town_or_city|as_crispy_field }}
          {{ order_form.street_address1|as_crispy_field }}
          {{ order_form.street_address2|as_crispy_field }}
          {{ order_form.county|as_crispy_field }}
        </fieldset>

        <!-- Save Info -->
        {% if user.is_authenticated %}
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="id-save-info" name="save-info" checked>
          <label class="form-check-label small" for="id-save-info">
            Save this delivery info to my profile
          </label>
        </div>
        {% else %}
        <p class="small text-muted">
          <a href="{% url 'account_signup' %}" class="text-accent-blue">Create an account</a> or
          <a href="{% url 'account_login' %}" class="text-accent-blue">log in</a> to save your info.
        </p>
        {% endif %}

        <!-- Payment Section -->
        <fieldset class="mb-4">
          <legend class="small text-accent-blue">Payment</legend>
          <div id="card-element" class="stripe-style-input"></div>
          <div id="card-errors" class="text-danger small mt-2" role="alert"></div>
        </fieldset>

        <!-- Buttons -->
        <div class="text-right mt-4">
          <a href="{% url 'bag:view_bag' %}" 
             class="btn rounded-pill text-white px-4 py-2 mr-2" 
             style="background-color: var(--accent-pink); border: none;">
            <i class="fas fa-chevron-left mr-1"></i> Back to Bag
          </a>
          <button type="submit" id="submit-button" 
                  class="btn rounded-pill text-white px-4 py-2" 
                  style="background-color: var(--accent-blue); border: none;">
            Complete Order <i class="fas fa-lock ml-1"></i>
          </button>
        </div>

        <p class="small text-muted text-right mt-2">
          <i class="fas fa-info-circle"></i> Your card will be charged 
          <strong>£{{ grand_total|floatformat:2 }}</strong>
        </p>
      </form>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <div class="loading-spinner">
    <i class="fas fa-spinner fa-spin fa-3x text-accent-blue"></i>
    <p class="mt-3 text-accent-blue">Processing Payment...</p>
  </div>
</div>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
{{ stripe_public_key|json_script:"id_stripe_public_key" }}
{{ client_secret|json_script:"id_client_secret" }}
<script src="{% static 'checkout/js/stripe_elements.js' %}"></script>
{% endblock %}
